<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>CIBMTR-REPORTING\Connection Guide - FHIR v4.0.1</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link href="fhir.css" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap-fhir.css" rel="stylesheet"/>

    <!-- Project extras -->
    <link href="assets/css/project.css" rel="stylesheet"/>
    <link href="assets/css/pygments-manni.css" rel="stylesheet"/>
    <link href="assets/css/jquery-ui.css" rel="stylesheet"/>
  	<link href="assets/css/prism.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->
<link href="assets/css/cibmtr.css" rel="stylesheet" />

    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>

    <style type="text/css">h2{--heading-prefix:"2"}
    h3,h4,h5,h6{--heading-prefix:"2"}</style>
    <div id="segment-header" class="segment">  <!-- segment-header -->
      <div class="container">  <!-- container -->
        <!-- Placeholder for child template header declarations -->

<div id="cibmtr-nav">
  <a id="cibmtr-logo" no-external="true" href="http://www.cibmtr.org">
    <!-- <img height="50" alt="Visit the HL7 website" src="assets/images/hl7-logo-header.png" /> -->
    <img height="80" alt="Visit the CIBMTR website"
      src="assets/images/cibmtr-logo-header-3.png" />
  </a>
</div>

        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">CIBMTR Reporting Implementation Guide</span>
            <br/>
            <span style="display:inline-block;">0.1.4a - Trial Use 1


            </span>
          </p>
        </div>
      </div> <!-- /container -->
    </div>  <!-- /segment-header -->

    <div id="segment-navbar" class="segment">  <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">  <!-- container -->
        <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
          <!--status-bar-->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a class="navbar-brand hidden" href="http://hl7.org/fhir/R4/index.html">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
              <!-- menu.xml  -->

<ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <li>
    <a href="index.html">Home</a>
  </li>
  <li>
    <a href="toc.html">Table of Contents</a>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Guidance
      <b class="caret"></b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="Connection-Guide.html">Connection - R4</a>
      </li>
      <li>
        <a href="CRID-Assignment.html">CRID Assignment</a>
      </li>
      <li>
        <a href="Medications.html">Medications</a>
      </li>
      <li>
        <a href="Laboratory-Observations.html">Lab Observations</a>
      </li>
      <li>
        <a href="Form-2450.html">Form 2450</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="CIBMTR_Direct_FHIR_API_Connection_Guide_STU3.pdf">Direct FHIR (STU3)</a>
  </li>
  <li>
    <a href="artifacts.html">Artifact Index</a>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Support
      <b class="caret"></b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a target="_blank" href="http://hl7.org/fhir/R4/index.html">FHIR Spec </a>
      </li>
    </ul>
  </li>
</ul>
            </div>  <!-- /.nav-collapse -->
          </div>  <!-- /.container -->
        </nav>  <!-- /.navbar -->
      <!-- /HEADER CONTENT -->
      </div>  <!-- /container -->
    </div>  <!-- /segment-navbar -->
    <!--status-bar-->

    <div id="segment-breadcrumb" class="segment">  <!-- segment-breadcrumb -->
      <div class="container">  <!-- container -->
        <ul class="breadcrumb">
          <li><a href='toc.html'><b>Table of Contents</b></a></li><li><b>Connection Guide</b></li>

        </ul>
      </div>  <!-- /container -->
    </div>  <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment">  <!-- segment-content -->
      <div class="container">  <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<style type="text/css">
h2:before{color:silver;counter-increment:section;content:var(--heading-prefix) " ";}
h3:before{color:silver;counter-increment:sub-section;content:var(--heading-prefix) "." counter(sub-section) " ";}
h4:before{color:silver;counter-increment:composite;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) " ";}
h5:before{color:silver;counter-increment:detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) " ";}
h6:before{color:silver;counter-increment:more-detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) "." counter(more-detail)" ";}
</style>
<div class="col-12">
  <!--ReleaseHeader--><p id="publish-box">CIBMTR Reporting Implementation Guide - Local Development build (v0.1.4a). See the <a href="http://fhir.nmdp.org/ig/cibmtr-reporting/history.html">Directory of published versions</a></p><!--EndReleaseHeader-->
  <h2>Connection Guide</h2>
  












    <p><!-- white space is critical inside of capture --></p>
<div class="markdown-toc">
<ul id="markdown-toc">
  <li><a href="#cibmtr-direct-fhir-r4-connection-guide" id="markdown-toc-cibmtr-direct-fhir-r4-connection-guide">CIBMTR Direct FHIR R4 Connection Guide</a>    <ul>
      <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
      <li><a href="#access-credentials" id="markdown-toc-access-credentials">Access Credentials</a></li>
      <li><a href="#recommended-data-submission-workflow" id="markdown-toc-recommended-data-submission-workflow">Recommended Data Submission Workflow</a>        <ul>
          <li><a href="#step-1-register-patient-and-receive-crid" id="markdown-toc-step-1-register-patient-and-receive-crid">Step 1: Register patient and receive CRID</a></li>
          <li><a href="#step-2-search-for-existing-patient-resource-with-crid" id="markdown-toc-step-2-search-for-existing-patient-resource-with-crid">Step 2: Search for existing Patient resource with CRID</a></li>
          <li><a href="#step-3-submit-patient-fhir-resource" id="markdown-toc-step-3-submit-patient-fhir-resource">Step 3: Submit Patient FHIR Resource</a></li>
        </ul>
      </li>
      <li><a href="#submitting-cridfhir-data-using-the-postman-client" id="markdown-toc-submitting-cridfhir-data-using-the-postman-client">Submitting CRID/FHIR Data Using the Postman Client</a></li>
      <li><a href="#appendix-1-cibmtr-supported-labs-and-associated-loinc-codes" id="markdown-toc-appendix-1-cibmtr-supported-labs-and-associated-loinc-codes">Appendix 1: CIBMTR Supported Labs and Associated LOINC Codes</a></li>
      <li><a href="#appendix-2-frequently-asked-questions" id="markdown-toc-appendix-2-frequently-asked-questions">Appendix 2: Frequently Asked Questions</a></li>
      <li><a href="#appendix-3-example-code" id="markdown-toc-appendix-3-example-code">Appendix 3: Example Code</a></li>
    </ul>
  </li>
</ul>

</div>
<h1 id="cibmtr-direct-fhir-r4-connection-guide">CIBMTR Direct FHIR R4 Connection Guide</h1>

<h2 id="introduction">Introduction</h2>

<p>CIBMTR collects clinical research data related to stem-cell transplants including patient characteristics, disease parameters, procedures, treatments, and longitudinal outcomes. Typically, this data is collected using an online form called FormsNet and populated by a data manager associated with a transplant center or hospital.  CIBMTR is committed to minimizing the data collection effort for transplant centers and data managers and is actively working to collect data electronically from transplant center Electronic Health Records (EHR) systems.  CIBMTR is engaged in a program called the Data Transformation Initiative (DTI) where electronic data is collected and used to prepopulate the questions on the applicable CIBMTR forms. Prepopulating form questions reduces the number of questions required by the data managers to subsequently answer manually.</p>

<p>This document describes how to submit HL7 FHIR data electronically using available CIBMTR REST APIs.  Data for each patient is submitted using the HL7 FHIR exchange protocol in JSON or XML format. The REST APIs are available for integration into a custom client architecture or for submission using a manual HTTP client such as Postman. CIBMTR refers to data submitted directly to the CIBMTR FHIR API using a custom client as Direct FHIR data submission.</p>

<p>The process for submitting production data to CIBMTR includes three sequential steps:</p>
<ol>
  <li>Request CIBMTR Direct FHIR Service API Access Credentials</li>
  <li>Submit test data using the CIBMTR test API endpoint URLs</li>
  <li>Submit production data with the CIBMTR production API endpoint URLs</li>
</ol>

<p>Once electronic data has been submitted via the Direct FHIR service API, the Data Manager can login to the FormsNet interface to complete the data submission process for form prepopulation. Associated with each form are important clarifying contextual questions that must be answered to provide necessary information for associating the dates of the electronic data with the key dates of interest on the form.  Answering these contextual questions within FormsNet initiates the electronic data form prepopulation for a specific form.</p>

<h2 id="access-credentials">Access Credentials</h2>
<p>A CIBMTR relationship manager or technical lead can initiate a request for API credentials.  CIBMTR uses OAuth2.0/OpenID (OIDC) for authentication and access management.  This process involves making a request to a third-party authorization server to receive a token.  The token is then passed to the CIBMTR API URL in the request header.  The following information will be provided by CIBMTR and is necessary for requesting an authorization token :</p>

<ul>
  <li>CIBMTR Service Account Username</li>
  <li>Application Client ID</li>
  <li>Application Client Secret</li>
  <li>Application Scope</li>
</ul>

<p>Different sets of credentials will be provided for the CIBMTR test and production environments.</p>

<p>To request an authentication token for the test environment, the third-party authorization server URL is:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST    https://nmdp.oktapreview.com/oauth2/ausaexcazhLhxKnJs0h7/v1/token
</code></pre></div></div>
<p>or:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST    https://nmdp.oktapreview.com/oauth2/aus3ck6q30qmOdpMb1t7/v1/token
</code></pre></div></div>

<p>To request an authentication token for the production environment, the third-party authorization server URL is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST    https://nmdp.okta.com/oauth2/ausaexcazhLhxKnJs0h7/v1/token
</code></pre></div></div>
<p>or:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST    https://nmdp.okta.com/oauth2/aus3ck6q30qmOdpMb1t7/v1/token
</code></pre></div></div>

<p>The header of the POST request to the authorization server must have an authorization string.  The string is constructed by base64 encoding the Application Client ID, a colon, and the Application Client Secret.  The encoded string is then appended to the word <code class="language-plaintext highlighter-rouge">Basic </code>.  For example, here is a snippet of psuedocode showing this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const auth_string = "Basic " + base64("&lt;Application Client ID&gt;" + ":" + "&lt;Application Client Secret&gt;")
</code></pre></div></div>

<p>An example of the header parameters for the POST request to the authorization server using the Postman API client tool (https://www.postman.com) is shown in Figure 1.  In the figure, the authorization string is blacked out.  Notice the space between the base 64 encoded string and the string prefix, <code class="language-plaintext highlighter-rouge">Basic</code>.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure01.png" alt="Figure 1" width="50%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 1: Example header information for the POST request to the authorization server</i></td>
    </tr>
  </tbody>
</table>

<p>Figure 2 below shows the required fields in the body of the POST request to the authorization server API. The value for the <code class="language-plaintext highlighter-rouge">username</code> key is the CIBMTR Service Account Username provided by CIBMTR.   The value for the <code class="language-plaintext highlighter-rouge">password</code> key is the CIBMTR Service Account Password.  The <code class="language-plaintext highlighter-rouge">grant_type</code> key and the <code class="language-plaintext highlighter-rouge">scope</code> key have the same values as shown in Figure 2.  The response to the POST request will return a JSON object that includes a base64 encoded token.  The token can be a long character string (over 1000 chars).</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure02.png" alt="Figure 2" width="50%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 2: Required POST fields to submit for the authorization token.</i></td>
    </tr>
  </tbody>
</table>

<p>Once the token has been received, a request to the CIBMTR Direct FHIR service API can be made. Tokens are valid for 30 minutes in the production environment, but last up to 24 hours in the test environment.  Applications must cache and re-use tokens until they are about to expire because Okta rate limits requests for new tokens. One workable strategy is to obtain a new token every 25 minutes.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure03.png" alt="Figure 3" width="50%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 3: Example CIBMTR Direct FHIR API request using a bearer authorization token in the header of the request.</i></td>
    </tr>
  </tbody>
</table>

<p>To make a request to the CIBMTR Direct FHIR Backend API, include the token in the header as the authorization key value of the request along with the word <code class="language-plaintext highlighter-rouge">Bearer </code> in front of it, as shown in Figure 3.</p>

<h2 id="recommended-data-submission-workflow">Recommended Data Submission Workflow</h2>

<p>Submitting data to CIBMTR via the Direct FHIR service API involves a four-step process for each patient:</p>
<ol>
  <li>Register/lookup patient and receive CRID</li>
  <li>Check for existing Patient resource</li>
  <li>Create new Patient resource only if it doesn’t already exist</li>
  <li>Send Observation using Patient resource as subject reference</li>
</ol>

<p>Before we dive into the workflow, there are a couple of things to be aware of:  the <code class="language-plaintext highlighter-rouge">&lt;base urls&gt;</code> and security tags.</p>

<p><strong>Base URLs</strong></p>

<p>For the CRID API, and all FHIR STU3 resources, use these <code class="language-plaintext highlighter-rouge">&lt;base URLs&gt;</code> in the examples that follow.</p>

<p><em>Test Environment (to be used for all development work)</em></p>

<blockquote>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://dev-api.nmdp.org/cibmtr-fhir-backend-exttest/v1
</code></pre></div>  </div>
</blockquote>

<p><em>Production Environment</em></p>

<blockquote>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://api.nmdp.org/cibmtrehrclientbackend/v1
</code></pre></div>  </div>
</blockquote>

<p><strong>Security tags</strong></p>

<p>Access credentials have been provisioned to allow access to patients and data that is identified to a particular transplant center. To enforce this, the Direct FHIR API requires that all FHIR resources contain a <code class="language-plaintext highlighter-rouge">meta.security</code> element containing the center number in a FHIR CodeableConcept. This has the form of:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://cibmtr.org/codesystem/transplant-center"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rc_&lt;CCN&gt;"</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">meta.security.code</code> is a string containing <code class="language-plaintext highlighter-rouge">rc_</code> followed by the CIBMTR Center Number (CCN). In the above example, replace <code class="language-plaintext highlighter-rouge">&lt;CCN&gt;</code> with your center number.  Examples of FHIR resources containing this element are found in the sections below.</p>

<h3 id="step-1-register-patient-and-receive-crid">Step 1: Register patient and receive CRID</h3>

<p>The client must search for a patient that has been previously registered with CIBMTR, or register a new patient. In either case, the client will receive from the CRID service a CIBMTR Research Identifier (CRID) to be used as a patient resource identifier for all subsequent FHIR data submissions.  CIBMTR exposes a special service API to handle the submission of personally identifiable information (PII).  Data submitted via the externally available CRID API endpoint has special protections and exposure within CIBMTR to avoid unnecessary handling of PII.  For all subsequent FHIR data submissions, the CRID is used to identify the patient and any PII is removed from FHIR resources before being stored on CIBMTR FHIR servers.</p>

<p>The CRID API uses a <code class="language-plaintext highlighter-rouge">PUT</code> request at the following case-sensitive endpoint URLs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT    &lt;base URL&gt;/CRID
</code></pre></div></div>

<p>The authorization key and bearer token must be included in the request as mentioned in the previous section.  For the body of the PUT request, the following data fields are requested:</p>

<p><strong>Five  required attributes</strong></p>
<ul>
  <li>CCN (5digit)</li>
  <li>First name</li>
  <li>Last name</li>
  <li>Birthdate (YYYY-MM-DD)</li>
  <li>Gender (M/F)</li>
</ul>

<p><strong>Optional attributes (possibly present)</strong></p>
<ul>
  <li>SSN (###-##-####)</li>
  <li>Mother’s maiden name</li>
  <li>Race (race code)</li>
  <li>Ethnicity (ethnicity code)</li>
  <li>NMDP RID</li>
  <li>EBMT CIC + ID</li>
  <li>CIBMTR Team + IUBMID</li>
</ul>

<p>Complete list of payload options for CRID registration is shown below. Note that this is not a FHIR JSON object, but rather is a CIBMTR specific JSON format.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"ccn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"patient"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"firstName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"lastName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"birthDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ssn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"mothersMaidenName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"race"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"string"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"ethnicity"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"nmdpRid"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ebmtCic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"cibmtrIubmid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"cibmtrTeam"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">        
        </span><span class="nl">"ebmtId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">        
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><strong>CRID Race Codes</strong></p>

<table class="grid">
  <thead>
    <tr>
      <th>Race Value Code</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1002-5</td>
      <td>American Indian or Alaska Native</td>
    </tr>
    <tr>
      <td>2028-9</td>
      <td>Asian</td>
    </tr>
    <tr>
      <td>2054-5</td>
      <td>Black or African American</td>
    </tr>
    <tr>
      <td>2076-8</td>
      <td>Native Hawaiian or Other Pacific Islander</td>
    </tr>
    <tr>
      <td>2106-3</td>
      <td>White</td>
    </tr>
    <tr>
      <td>ASKU</td>
      <td>Not Reported</td>
    </tr>
    <tr>
      <td>UNK</td>
      <td>Unknown</td>
    </tr>
  </tbody>
</table>

<p><strong>CRID Ethnicity Codes</strong></p>

<table class="grid">
  <thead>
    <tr>
      <th>Ethnicity Value Code</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2135-2</td>
      <td>Hispanic or Latino</td>
    </tr>
    <tr>
      <td>2186-5</td>
      <td>Non Hispanic or Latino</td>
    </tr>
    <tr>
      <td>UNK</td>
      <td>Unknown</td>
    </tr>
  </tbody>
</table>

<p>Because the CRID API is available as a <code class="language-plaintext highlighter-rouge">PUT</code> request, submitting the same data twice does not re-register the patient, but rather will retrieve the same CRID number registered previously.   The CRID API will attempt to perform partial “fuzzy” matches based on data submitted to avoid re-registering the same patient with two different CRID numbers.</p>

<p>The response payload of the CRID Service API is a JSON object that contains the CRID number (lower pane in Figure 4).  The CRID number is then used for all other data references to the registered patient.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure04.png" alt="Figure 4" width="50%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 4: Example CRID registration PUT request with JSON body payload (top pane) and response payload (bottom pane)</i></td>
    </tr>
  </tbody>
</table>

<h3 id="step-2-search-for-existing-patient-resource-with-crid">Step 2: Search for existing Patient resource with CRID</h3>

<p>A FHIR Patient resource with an identifier containing the CRID must exist to be used as a subject reference in Observation or other resources. To prevent multiple identical Patient resources from being created, the client must first check to see if it already exists.</p>

<p>To search for Patient resource with a specific CRID, use this GET request (all one line)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET &lt;base URL&gt;/r3/Patient?
    _security=http://cibmtr.org/codesystem/transplant-center|rc_&lt;CCN&gt;
    &amp;identifier=http://cibmtr.org/identifier/CRID|&lt;CRID&gt;
</code></pre></div></div>

<p>If the response shows a searchset result with a <code class="language-plaintext highlighter-rouge">total</code> of 0, then a Patient resource with that CRID has not been created, and a new Patient resource must be created. In this case, go on to Step 3.</p>

<p>If the response shows a <code class="language-plaintext highlighter-rouge">total</code> of one or more, then at least one Patient with that CRID already exists. In this case, skip Step 3, and go on to Step 4. If more than one Patient was found, then it suggests that someone created a Patient without checking to see if it first exists.</p>

<p>A note about special characters:  The FHIR search parameters sometime include special characters such as the pipe character (“<code class="language-plaintext highlighter-rouge">|</code>”). Often, these need to be replaced with url-encoded character strings. In this case, “<code class="language-plaintext highlighter-rouge">|</code>” is replaced by “<code class="language-plaintext highlighter-rouge">%7C</code>” in the values for the keys.</p>

<p>The response below shows one Patient resource, and that resource has an <code class="language-plaintext highlighter-rouge">id</code> of 46986.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure05.png" alt="Figure 5" width="50%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 5: Example of response of Patient search</i></td>
    </tr>
  </tbody>
</table>

<p>The ‘id’ should be used in all <code class="language-plaintext highlighter-rouge">subject.references</code> for all subsequent Observations that are submitted for this Patient. This would have the form of:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"subject"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"reference"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Patient/&lt;id&gt;"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">&lt;id&gt;</code> with the <code class="language-plaintext highlighter-rouge">Patient.id</code> found in the search.</p>

<p>To drive home the point, the</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Patient.id</code> is a local server id, and is used as a subject.reference in other FHIR resources.</li>
  <li><code class="language-plaintext highlighter-rouge">Patient.identifier</code> is a business identifier and the where the CRID is located.</li>
</ul>

<h3 id="step-3-submit-patient-fhir-resource">Step 3: Submit Patient FHIR Resource</h3>

<p>If the Patient FHIR resource doesn’t already exist, it must be created before any other FHIR resources.  The Patient FHIR resource ID is part of the response to the Patient POST request.  The resource ID is unique to the CIBMTR FHIR server and is used to reference the Patient subject on all subsequently submitted FHIR resources. The resource ID is assigned by the FHIR server and is different from the Patient.identifier section of the FHIR resource. The Patient ID is <strong>NOT</strong> a Patient CRID.</p>

<p>The Direct FHIR Service API uses a POST request to submit a Patient resource at the following case-sensitive endpoint URLs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST    &lt;base URL&gt;/r3/Patient
</code></pre></div></div>

<p>The authorization key and bearer token must be included in the request as mentioned in the previous section.  FHIR JSON submissions should also include a <code class="language-plaintext highlighter-rouge">content-type</code> key in the header with value: <code class="language-plaintext highlighter-rouge">application/fhir+json</code>.</p>

<h4 id="minimum-patient-resource">Minimum Patient resource</h4>
<p>The Patient FHIR resource usually contains the demographics data for the patient, however, since the demographics data is already submitted during the CRID registration process, there are only three primary components necessary in the Patient FHIR resource:</p>

<ol>
  <li>A <code class="language-plaintext highlighter-rouge">security</code> label (describe above) within the <code class="language-plaintext highlighter-rouge">meta</code> section of the Patient resource must contain the CIBMTR Center Number (CCN) prepended with <code class="language-plaintext highlighter-rouge">rc_</code> and associated with the codesystem as shown in Figure 6.</li>
  <li>A <code class="language-plaintext highlighter-rouge">text.status</code> section that should have the narrative code of <code class="language-plaintext highlighter-rouge">empty</code> if no text narrative is provided.  An example is shown in Figure 6.</li>
  <li>A CRID identifier reference within the <code class="language-plaintext highlighter-rouge">identifier</code> section of the Patient resource as shown in Figure 6.</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure06.png" alt="Figure 6" width="50%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 6: Example POST request to submit a Patient FHIR resource and the required FHIR sections in the body of the request</i></td>
    </tr>
  </tbody>
</table>

<p>PII information should be avoided as part of the Patient resource.   However, the Direct FHIR service API will remove PII information, including any that might be contained in <code class="language-plaintext highlighter-rouge">text.div</code> or other sections of the resource before storing it on the FHIR server.</p>

<p>The response after submitting a Patient resource request, includes the Patient resource ID in the header of the response (see Figure 7).   The <code class="language-plaintext highlighter-rouge">Location</code> section of the response header includes a URL reference for the Patient resource on the CIBMTR FHIR server and the Patient resource ID is in the URL (circled in red in Figure 7).   The Patient resource ID is necessary for submitting other FHIR resources to the Direct FHIR service API, but if the ID for a Patient resource previously submitted is not known, the following GET request can be submitted to the API to retrieve the Patient resource for a given CRID:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure07.png" alt="Figure 7" width="50%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 7: Example FHIR Patient submission response with the Patient resource ID found in the response header Location</i></td>
    </tr>
  </tbody>
</table>

<p>Preferred Patient resource
While including the CRID identifier, meta.security tag, and empty text element is the bare minimum for creating a Patient resource, we prefer to have some additional data present to help with resource management. These include date of birth, gender, and race &amp; ethnicity information. Race and ethnicity must be reported as described in the FHIR US-Core Implementation Guide:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">https://www.hl7.org/fhir/us/core/StructureDefinition-us-core-race.html</code></li>
  <li><code class="language-plaintext highlighter-rouge">https://www.hl7.org/fhir/us/core/StructureDefinition-us-core-ethnicity.html</code></li>
</ul>

<p>See the following for an example that using these elements with data as found for registering for the CRID above.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Patient"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://cibmtr.org/codesystem/transplant-center"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rc_12002"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]},</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"empty"</span><span class="p">},</span><span class="w">
    </span><span class="nl">"identifier"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"use"</span><span class="p">:</span><span class="w"> </span><span class="s2">"official"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://cibmtr.org/identifier/CRID"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4598886"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"male"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"birthDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1925-07-04"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"extension"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"extension"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ombCategory"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"valueCoding"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.16.840.1.113883.6.238"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2106-3"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"White"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"valueString"</span><span class="p">:</span><span class="w"> </span><span class="s2">"White"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://hl7.org/fhir/us/core/StructureDefinition/us-core-race"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Note that ethnicity is not included in the above example. This is because valueset for the US-Core Ethnicity Extension does not include Unknown which was submitted to the CRID service. To be conformant to the FHIR US-Core Implementation Guide, it must be either “Hispanic or Latino” or “Non Hispanic or Latino.” Please contact us if you have any questions on how to implement these extensions.</p>

<p>Here’s an example with ethnicity included:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Patient"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://cibmtr.org/codesystem/transplant-center"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rc_12002"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]},</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"empty"</span><span class="p">},</span><span class="w">
    </span><span class="nl">"identifier"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"use"</span><span class="p">:</span><span class="w"> </span><span class="s2">"official"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://cibmtr.org/identifier/CRID"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4598886"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"male"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"birthDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1925-07-04"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"extension"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"extension"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ombCategory"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"valueCoding"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.16.840.1.113883.6.238"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2106-3"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"White"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"valueString"</span><span class="p">:</span><span class="w"> </span><span class="s2">"White"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://hl7.org/fhir/us/core/StructureDefinition/us-core-race"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"extension"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ombCategory"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"valueCoding"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.16.840.1.113883.6.238"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2135-2"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hispanic or Latino"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"detailed"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"valueCoding"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.16.840.1.113883.6.238"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2184-0"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dominican"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"valueString"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hispanic or Latino"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="step-4-submit-observation-fhir-resources">Step 4: Submit Observation FHIR Resources</h4>

<p>The Direct FHIR service API uses a POST request to submit an Observation resource at the following case-sensitive endpoint URLs :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST    &lt;base URL&gt;/r3/Observation
</code></pre></div></div>

<p>The authorization key and bearer token must be included in the request as mentioned in the previous section.  FHIR JSON submissions should also include a <code class="language-plaintext highlighter-rouge">content-type</code> key in the header with value: <code class="language-plaintext highlighter-rouge">application/fhir+json</code>.</p>

<p>CIBMTR is continually expanding support for more electronic data to pre-populate CIBMTR forms.  The list of data that can be submitted and used to populate CIBMTR forms is provided in Appendix 1. When mapping electronic data to clinical codes, it is imperative that the correct code is used. It is recommended that someone with a clinical background review the mappings of EHR data to clinical codes to ensure accuracy.</p>

<p>An example of an Observation FHIR resource is shown in Figure 8.  The basic structure of this FHIR resource is the same for all the different types of labs.  Important areas to note:</p>

<p>•	<code class="language-plaintext highlighter-rouge">meta</code> Section – This is the metadata section of the resource and includes the same security label as defined in the Patient resource.  This security label is <strong>required</strong> and must include the center specific CCN.</p>

<p>•	<code class="language-plaintext highlighter-rouge">category</code> Section – This section uses the HL7 Observation category code to enable category-based searches.  Currently, only data from the <code class="language-plaintext highlighter-rouge">laboratory</code> category is supported.  This section is optional.</p>

<p>•	<code class="language-plaintext highlighter-rouge">code</code> Section – The clinical concept code for the measured quantity is included in this section.  For laboratory data, the primary clinical vocabulary is LOINC .  LOINC codes can have different specific applied concepts depending on a variety of lab parameters such as: collection method, measurement method, sub-types, and naming conventions.  A list of LOINC codes for each of the supported lab types is included in Appendix 1.  Choosing the correct code can require clinical interpretation, therefore, technical implementers are encouraged to get clinician review of the selected LOINC code. This section is <strong>required</strong>.</p>

<p>•	<code class="language-plaintext highlighter-rouge">subject</code> Section – Each Observation resource must reference the patient associated with the lab values.  The subject.reference allows the Observation resource to point to the Patient using the Patient resource <code class="language-plaintext highlighter-rouge">id</code> using the <code class="language-plaintext highlighter-rouge">Patient/&lt;id&gt;</code> format.   This section is <strong>required</strong>.</p>

<p>•	<code class="language-plaintext highlighter-rouge">effectiveDateTime</code> – This is a timezone aware datetime format of the date of collection of the lab sample.  This section is <strong>required</strong>.</p>

<p>•	<code class="language-plaintext highlighter-rouge">valueQuantity</code> – The actual value of the measured lab is represented here as a decimal valued number. The unit system and code are also specified. The CIBMTR data translation engine will convert the values and units after submission if necessary.  The units system and code should be UCUM.  This section is <strong>required</strong>.</p>

<p>•	<code class="language-plaintext highlighter-rouge">referenceRange</code><code class="language-plaintext highlighter-rouge"> – If the high and low range for this lab are known, they can be defined in this section using the same data format as the valueQuantity</code> section.   This section is optional but important for answering some questions on the CIBMTR forms.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure08.png" alt="Figure 8" width="80%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 8: Example FHIR Observation submission</i></td>
    </tr>
  </tbody>
</table>

<h4 id="search-for-all-observations-for-a-crid">Search for all Observations for a CRID</h4>

<p>To search for all Observation resources on the CIBMTR FHIR server for a given CRID, see the below GET request API URL:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET    &lt;base URL&gt;/r3/Observation?patient.identifier=&lt;CRID&gt;
</code></pre></div></div>

<h4 id="observation-bundles">Observation Bundles</h4>

<p>Multiple Observation FHIR resources can be submitted together in one Bundle FHIR resource.  The CIBMTR Direct FHIR service API supports FHIR transaction bundles.  The process for submitting a transaction Bundle FHIR resource is the same as submitting a single Observation FHIR resource, except for the bundle is sent to the base URL for the FHIR version for processing. If the bundle is sent to the Bundle end point, then it is stored, but not processed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST    &lt;base URL&gt;/r3
</code></pre></div></div>

<p>An example of the structure of a transaction JSON Bundle FHIR resource is shown below.  Each Observation resource is an element of the “entry” array.  To avoid API timeout issues, bundles should be limited to 50 Observations or less.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bundle"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"transaction"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"entry"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">Observation</span><span class="w"> </span><span class="err">Resource</span><span class="w"> </span><span class="err">Here</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Observation"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">Observation</span><span class="w"> </span><span class="err">Resource</span><span class="w"> </span><span class="err">Here</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Observation"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">Observation</span><span class="w"> </span><span class="err">Resource</span><span class="w"> </span><span class="err">Here</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Observation"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="submitting-cridfhir-data-using-the-postman-client">Submitting CRID/FHIR Data Using the Postman Client</h2>

<p>The example API calls in this document are taken from the Postman API client. Postman allows a user to manually configure and test connecting to and interacting with different APIs. Using Postman is a great way to understand an API, see the responses, and submit limited data manually.  Once the API is well understood, then a custom client can be implemented programmatically using any number of REST client libraries.</p>

<p>Postman includes the concept of a collection of requests. A collection file can be imported into Postman.  CIBMTR has a collection of requests that accomplish all the tasks in this user guide.  The collection is available upon request.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="dfhir_r3_figure09.png" alt="Figure 9" width="100%" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><i>Figure 9: Example POSTMAN collection of requests available from CIBMTR</i></td>
    </tr>
  </tbody>
</table>

<p>Postman also includes the option to run a pre-request script before making an API request. The CIBMTR collection includes a pre-request script that can get the authentication token automatically each time a request is made. These and other simplifications of the process make Postman an excellent tool for exploring, developing, and using the CIBMTR Direct FHIR service APIs for submitting patient data.</p>

<p>NOTE: Requesting a new token for manual requests should not cause Okta to rate-limit these requests.  However, automated systems must cache and re-use the authentication token to avoid errors.  Tokens are valid for 30 minutes in the production environment.</p>

<h2 id="appendix-1-cibmtr-supported-labs-and-associated-loinc-codes">Appendix 1: CIBMTR Supported Labs and Associated LOINC Codes</h2>

<p>CIBMTR currently supports submission of lab measurements collected prior to and post-HCT transfusion.  When submitting FHIR Observation resources, one of the below supported LOINC codes must be used in the code section of the resource.  Selecting the correct LOINC code to use to represent the clinical concept of the lab data should be done by someone clinically trained to understand the lab measurement and corresponding LOINC code.  Lab quantities should always include the corresponding unit of measure coded using the UCUM standard vocabulary.</p>

<p>A FHIR ValueSet representing these codes can be found on
https://fhir.nmdp.org/ig/cibmtr-reporting/ValueSet-cibmtr-priority-variables-2022.html</p>

<h2 id="appendix-2-frequently-asked-questions">Appendix 2: Frequently Asked Questions</h2>

<p><strong><em>Can multiple patients be registered at the same time using the CRID Service API?</em></strong></p>
<blockquote>
  <p>No, the API currently supports one CRID registration at a time.</p>
</blockquote>

<p><strong><em>Can demographic data be changed, augmented, or updated using the CRID Service API?</em></strong></p>
<blockquote>
  <p>No, contact CIBMTR to have the demographics data changed for a previously registered CRID</p>
</blockquote>

<p><strong><em>What can I do if I forget the CRID for a particular patient?</em></strong></p>
<blockquote>
  <p>Send the same PUT request to the CRID Service API with the same patient demographic information and the CRID Service API will return the corresponding CRID number for that patient.</p>
</blockquote>

<p><strong><em>What are the FHIR resources that are supported by the Direct FHIR service API?</em></strong></p>
<blockquote>
  <p>Patient, Observation</p>
</blockquote>

<p><strong><em>What forms are currently supported for prepopulation?</em></strong></p>
<blockquote>
  <p>The DTI program is engaging in prepopulating the data in Appendix 1 across all forms.  New supported data types will be supported approximately quarterly.</p>
</blockquote>

<p><strong><em>What if my lab data is not in the preferred unit of measure indicated on a form?</em></strong></p>
<blockquote>
  <p>You may choose to perform the unit/value conversion yourself prior to the data submission, or submit the data with the corresponding UCUM code, and the CIBMTR data translation engine will attempt to perform the conversion after submission.</p>
</blockquote>

<p><strong><em>Can the Observation resources be submitted as a FHIR bundle?</em></strong></p>
<blockquote>
  <p>Yes, transaction bundles are currently supported.</p>
</blockquote>

<h2 id="appendix-3-example-code">Appendix 3: Example Code</h2>

<h4 id="request-authorization-token">Request Authorization Token</h4>
<p><em>Python</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>

<span class="n">clientId</span> <span class="o">=</span> <span class="s">'&lt;Application Client ID&gt;'</span>
<span class="n">clientSecret</span> <span class="o">=</span> <span class="s">'&lt;Appplication Client Secret&gt;'</span>
<span class="n">serviceAccountUsername</span> <span class="o">=</span> <span class="s">'&lt;CIBMTR Service Account Username&gt;'</span>
<span class="n">serviceAccountPassword</span> <span class="o">=</span> <span class="s">'&lt;CIBMTR Service Account Password&gt;'</span>
<span class="n">scope</span> <span class="o">=</span> <span class="s">'&lt;Application Scope&gt;'</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/x-www-form-urlencoded'</span><span class="p">,</span> 
           <span class="s">'Accept'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">}</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'grant_type'</span><span class="p">:</span><span class="s">'password'</span><span class="p">,</span> 
        <span class="s">'scope'</span><span class="p">:</span> <span class="n">scope</span><span class="p">,</span> 
        <span class="s">'username'</span><span class="p">:</span><span class="n">serviceAccountUsername</span><span class="p">,</span> 
        <span class="s">'password'</span><span class="p">:</span><span class="n">serviceAccountPassword</span><span class="p">}</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://nmdp.oktapreview.com/oauth2/ausaexcazhLhxKnJs0h7/v1/token'</span><span class="p">,</span>
                  <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">clientId</span><span class="p">,</span> <span class="n">clientSecret</span><span class="p">),</span>
                  <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                  <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="n">accessToken</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">"access_token"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">accessToken</span><span class="p">)</span>
</code></pre></div></div>

<p><em>bash script using curl, base64, and jq</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">username</span><span class="o">=</span><span class="s1">'&lt;CIBMTR Service Account Username&gt;'</span>
<span class="nv">password</span><span class="o">=</span><span class="s1">'CIBMTR Service Account Password&gt;'</span>
<span class="nv">clientid</span><span class="o">=</span><span class="s1">'&lt;Application Client ID&gt;'</span>
<span class="nv">clientsecret</span><span class="o">=</span><span class="s1">'&lt;Application Client Secret&gt;'</span>
<span class="nv">clientscope</span><span class="o">=</span><span class="s1">'&lt;Application Scope&gt;'</span>

<span class="nv">auth_string</span><span class="o">=</span><span class="s2">"Basic </span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="k">${</span><span class="nv">clientId</span><span class="k">}</span>:<span class="k">${</span><span class="nv">clientSecret</span><span class="k">}</span>|base64<span class="si">)</span><span class="s2">"</span>

curl <span class="nt">-s</span> <span class="nt">--location</span> <span class="se">\</span>
<span class="nt">--request</span> POST <span class="s1">'https://nmdp.oktapreview.com/oauth2/ausaexcazhlhxknjs0h7/v1/token'</span> <span class="se">\</span>
<span class="nt">--header</span> <span class="s1">'Accept: application/json'</span> <span class="se">\</span>
<span class="nt">--header</span> <span class="s1">'Content-Type: application/x-www-form-urlencoded'</span> <span class="se">\</span>
<span class="nt">--header</span> <span class="s2">"Authorization: </span><span class="k">${</span><span class="nv">auth_string</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">--data-urlencode</span> <span class="s2">"grant_type=password"</span> <span class="se">\</span>
<span class="nt">--data-urlencode</span> <span class="s2">"scope=</span><span class="k">${</span><span class="nv">clientScope</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">--data-urlencode</span> <span class="s2">"username=</span><span class="k">${</span><span class="nv">username</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">--data-urlencode</span> <span class="s2">"password=</span><span class="k">${</span><span class="nv">password</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.access_token'</span>
</code></pre></div></div>
<p> </p>
<h4 id="crid-lookupregistration">CRID Lookup/Registration</h4>
<p><em>Python</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Replace patient variable with your patient demographic data. 
# Below is just an example.
</span><span class="n">patient</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"ccn"</span><span class="p">:</span> <span class="s">"12002"</span><span class="p">,</span>
    <span class="s">"patient"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"firstName"</span><span class="p">:</span> <span class="s">"Steve"</span><span class="p">,</span>
        <span class="s">"lastName"</span><span class="p">:</span> <span class="s">"Rogers"</span><span class="p">,</span>
        <span class="s">"birthDate"</span><span class="p">:</span> <span class="s">"1925-07-04"</span><span class="p">,</span>
        <span class="s">"gender"</span><span class="p">:</span> <span class="s">"M"</span><span class="p">,</span>
        <span class="s">"ssn"</span><span class="p">:</span> <span class="s">"098-76-5432"</span><span class="p">,</span>
        <span class="s">"race"</span><span class="p">:</span> <span class="p">[</span><span class="s">'2106-3'</span><span class="p">],</span>
        <span class="s">"ethnicity"</span><span class="p">:</span> <span class="s">"UNK"</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">tokenfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'token.txt'</span><span class="p">)</span>  <span class="c1"># Bearer token was previously captured in token.txt
</span><span class="n">authstring</span> <span class="o">=</span> <span class="s">'Bearer '</span> <span class="o">+</span> <span class="n">tokenfile</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="n">authstring</span><span class="p">,</span>
            <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s">'https://dev-api.nmdp.org/cibmtrehrclientbackendexttest/v1/CRID'</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="n">patient</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
</code></pre></div></div>

<p> </p>
<h4 id="patient-search-by-crid">Patient search by CRID</h4>
<p><em>Python</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># replace &lt;CRID&gt; with actual CRID
</span><span class="n">crid</span> <span class="o">=</span> <span class="s">"&lt;CRID&gt;"</span>

<span class="c1"># Bearer token captured in token.txt
</span><span class="n">tokenfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'token.txt'</span><span class="p">)</span>
<span class="n">authstring</span> <span class="o">=</span> <span class="s">'Bearer '</span> <span class="o">+</span> <span class="n">tokenfile</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="n">authstring</span><span class="p">}</span>

<span class="n">identifier</span> <span class="o">=</span> <span class="s">'http://cibmtr.org/identifier/CRID|'</span> <span class="o">+</span> <span class="n">crid</span>
<span class="n">security</span> <span class="o">=</span> <span class="s">'http://cibmtr.org/codesystem/transplant-center|rc_12002'</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'identifier'</span><span class="p">:</span> <span class="n">identifier</span><span class="p">,</span>
    <span class="s">'_security'</span><span class="p">:</span> <span class="n">security</span>
<span class="p">}</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://dev-api.nmdp.org/cibmtr-fhir-backend-exttest/v1/r3/Patient'</span><span class="p">,</span>
                 <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                 <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">:</span>
    <span class="c1"># print(json.dumps(r.json(), indent=4))
</span>    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
</code></pre></div></div>

<p> </p>
<h4 id="post-patient">POST Patient</h4>
<p><em>Python</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Usage: python postPatient.py &lt;FHIR Patient resource json file&gt;"</span><span class="p">)</span>
<span class="n">fhirjsonfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">patientFHIR</span> <span class="o">=</span> <span class="n">fhirjsonfile</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>

<span class="c1"># Bearer token captured in token.txt
</span><span class="n">tokenfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'token.txt'</span><span class="p">)</span>
<span class="n">authstring</span> <span class="o">=</span> <span class="s">'Bearer '</span> <span class="o">+</span> <span class="n">tokenfile</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="n">authstring</span><span class="p">,</span>
           <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/fhir+json'</span><span class="p">}</span>


<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://dev-api.nmdp.org/cibmtr-fhir-backend-exttest/v1/r3/Patient'</span><span class="p">,</span>
                  <span class="n">data</span><span class="o">=</span><span class="n">patientFHIR</span><span class="p">,</span>
                  <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">:</span>
    <span class="c1"># print(json.dumps(r.json(), indent=4))
</span>    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Location'</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>
<p> </p>

<h4 id="post-observation">POST Observation</h4>
<p>Python 
note: POSTing an Observation is just like POSTing a Patient. You just need to change the endpoint to Observation.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Usage: python postObservation.py &lt;FHIR Observation resource json file&gt;"</span><span class="p">)</span>
<span class="n">fhirjsonfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">observation</span> <span class="o">=</span> <span class="n">fhirjsonfile</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>

<span class="c1"># Bearer token captured in token.txt
</span><span class="n">tokenfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'token.txt'</span><span class="p">)</span>
<span class="n">authstring</span> <span class="o">=</span> <span class="s">'Bearer '</span> <span class="o">+</span> <span class="n">tokenfile</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="n">authstring</span><span class="p">,</span>
           <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/fhir+json'</span><span class="p">}</span>


<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://dev-api.nmdp.org/cibmtr-fhir-backend-exttest/v1/r3/Observation'</span><span class="p">,</span>
                  <span class="n">data</span><span class="o">=</span><span class="n">observation</span><span class="p">,</span>
                  <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">:</span>
    <span class="c1"># print(json.dumps(r.json(), indent=4))
</span>    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Location'</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>
<p> </p>

<h4 id="observation-search-by-crid">Observation search by CRID</h4>
<p>Python</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Usage: python searchObservationCRID.py &lt;CRID&gt;"</span><span class="p">)</span>

<span class="c1"># Bearer token captured in token.txt
</span><span class="n">tokenfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'token.txt'</span><span class="p">)</span>
<span class="n">authstring</span> <span class="o">=</span> <span class="s">'Bearer '</span> <span class="o">+</span> <span class="n">tokenfile</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="n">authstring</span><span class="p">}</span>

<span class="n">identifier</span> <span class="o">=</span> <span class="s">'http://cibmtr.org/identifier/CRID|'</span> <span class="o">+</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">security</span> <span class="o">=</span> <span class="s">'http://cibmtr.org/codesystem/transplant-center|rc_12002'</span>

<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'patient.identifier'</span><span class="p">:</span> <span class="n">identifier</span><span class="p">,</span>
    <span class="s">'_security'</span><span class="p">:</span> <span class="n">security</span>
<span class="p">}</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://dev-api.nmdp.org/cibmtr-fhir-backend-exttest/v1/r3/Observation'</span><span class="p">,</span>
                 <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                 <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
</code></pre></div></div>




</div>
</div>  <!-- /inner-wrapper -->
</div>  <!-- /row -->
</div>  <!-- /container -->
</div>  <!-- /segment-content -->

<script type="text/javascript" src="assets/js/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
<script type="text/javascript" src="assets/js/jquery-ui.min.js"> </script>

<script type="text/javascript">
$(document).ready(function(){
if(window.location.hash != "") {
    $('a[href="' + window.location.hash + '"]').click()
}
});
</script>
<div id="segment-footer" igtool="footer" class="segment">  <!-- segment-footer -->
<div class="container">  <!-- container -->
<div class="inner-wrapper">
  <p>
    IG &#169; 2020+ <a style="color: #81BEF7" href="http://www.cibmtr.org">The Medical College of Wisconsin, Inc. and the National Marrow Donor Program</a>  
    <br/>Package cibmtr-reporting#0.1.4a based on <a style="color: #81BEF7" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Wed, Aug 10, 2022 12:44-0500">2022-08-10</span>
    <br/>
    <span style="color: #FFFF77">
                Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                 
                
<div id="cibmtr-footer">
    <p>
    <br/>HL7&#174;, and FHIR&#174; are the registered trademarks of Health Level Seven International 
    and their use of these trademarks does not constitute an endorsement by HL7.
    </p>
</div>
    </span>
  </p>
</div>  <!-- /inner-wrapper -->
</div>  <!-- /container -->
</div>  <!-- /segment-footer -->

<div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
<div class="container">  <!-- container -->
</div>  <!-- /container -->
</div>  <!-- /segment-post-footer -->

<!-- JS and analytics only. -->
<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script type="text/javascript" src="assets/js/bootstrap.min.js"> </script>
<script type="text/javascript" src="assets/js/respond.min.js"> </script>
<script type="text/javascript" src="assets/js/anchor.min.js"> </script>
<script>anchors.options.visible = 'hover'
anchors.add()</script>

<!-- Analytics Below
================================================== -->
</body>
</html>

